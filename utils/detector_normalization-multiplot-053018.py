import sys
sys.path.append('/opt/mantidnightly/bin/')
from mantid.simpleapi import *
import matplotlib.pyplot as plt
from mantid import plots
from matplotlib.colors import LogNorm
import numpy as np
from mpl_toolkits.mplot3d import Axes3D
from scipy.optimize import curve_fit


data_folder = '/SNS/CNCS/IPTS-20360/nexus/'

runsA = range(273853,273853+1, 1) #0.54 meV TiZr
runsB = range(273854,273854+1, 1) #1.55 meV TiZr
runsC = range(273855,273855+1, 1) #3.32 meV TiZr
#runs = range(273859,273859+1, 1) #50.0 meV TiZr
#runs = range(273860,273860+1, 1) #80.0 meV TiZr

runs1 = range(273897,273897+1, 1) #0.54 meV V-foil
runs2 = range(273898,273898+1, 1) #1.55 meV V-foil
runs3 = range(273899,273899+1, 1) #3.32 meV V-foil
"""
runs4 = range(273900,273900+1, 1) #6.59 meV V-foil
runs5 = range(273901,273901+1, 1) #12.0 meV V-foil
runs6 = range(273902,273902+1, 1) #25.0 meV V-foil
runs7 = range(273903,273903+1, 1) #80.0 meV V-foil
"""
list_of_runs_Vfoil = [runs1, runs2, runs3]
list_of_runs_TiZr = [runsA, runsB, runsC]

#fig, ax = plt.subplots(subplot_kw={'projection':'mantid'})
fig, ax = plt.subplots()

for runs in list_of_runs_Vfoil:
    file_names = [data_folder + 'CNCS_{0}.nxs.h5'.format(r) for r in runs]
    data = Load('+'.join(file_names))

    LoadInstrument(data,FileName='/SNS/users/vdp/CNCS/2018B/CNCS_Definition_Pajerowski.xml', RewriteSpectraMap=False)

    MaskBTP(Workspace='data', Instrument='CNCS', Pixel='121-128, 1-8', MaskedDetectors='120-127,0-7,248-255,128-135,376-383,256-263,504-511,384-391,632-639,512-519,760-767,640-647,888-895,768-775,1016-1023,896-903,1144-1151,1024-1031,1272-1279,1152-1159,1400-1407,1280-1287,1528-1535,1408-1415,1656-1663,1536-1543,1784-1791,1664-1671,1912-1919,1792-1799,2040-2047,1920-1927,2168-2175,2048-2055,2296-2303,2176-2183,2424-2431,2304-2311,2552-2559,2432-2439,2680-2687,2560-2567,2808-2815,2688-2695,2936-2943,2816-2823,3064-3071,2944-2951,3192-3199,3072-3079,3320-3327,3200-3207,3448-3455,3328-3335,3576-3583,3456-3463,3704-3711,3584-3591,3832-3839,3712-3719,3960-3967,3840-3847,4088-4095,3968-3975,4216-4223,4096-4103,4344-4351,4224-4231,4472-4479,4352-4359,4600-4607,4480-4487,4728-4735,4608-4615,4856-4863,4736-4743,4984-4991,4864-4871,5112-5119,4992-4999,5240-5247,5120-5127,5368-5375,5248-5255,5496-5503,5376-5383,5624-5631,5504-5511,5752-5759,5632-5639,5880-5887,5760-5767,6008-6015,5888-5895,6136-6143,6016-6023,6264-6271,6144-6151,6392-6399,6272-6279,6520-6527,6400-6407,6648-6655,6528-6535,6776-6783,6656-6663,6904-6911,6784-6791,7032-7039,6912-6919,7160-7167,7040-7047,7288-7295,7168-7175,7416-7423,7296-7303,7544-7551,7424-7431,7672-7679,7552-7559,7800-7807,7680-7687,7928-7935,7808-7815,8056-8063,7936-7943,8184-8191,8064-8071,8312-8319,8192-8199,8440-8447,8320-8327,8568-8575,8448-8455,8696-8703,8576-8583,8824-8831,8704-8711,8952-8959,8832-8839,9080-9087,8960-8967,9208-9215,9088-9095,9336-9343,9216-9223,9464-9471,9344-9351,9592-9599,9472-9479,9720-9727,9600-9607,9848-9855,9728-9735,9976-9983,9856-9863,10104-10111,9984-9991,10232-10239,10112-10119,10360-10367,10240-10247,10488-10495,10368-10375,10616-10623,10496-10503,10744-10751,10624-10631,10872-10879,10752-10759,11000-11007,10880-10887,11128-11135,11008-11015,11256-11263,11136-11143,11384-11391,11264-11271,11512-11519,11392-11399,11640-11647,11520-11527,11768-11775,11648-11655,11896-11903,11776-11783,12024-12031,11904-11911,12152-12159,12032-12039,12280-12287,12160-12167,12408-12415,12288-12295,12536-12543,12416-12423,12664-12671,12544-12551,12792-12799,12672-12679,12920-12927,12800-12807,13048-13055,12928-12935,13176-13183,13056-13063,13304-13311,13184-13191,13432-13439,13312-13319,13560-13567,13440-13447,13688-13695,13568-13575,13816-13823,13696-13703,13944-13951,13824-13831,14072-14079,13952-13959,14200-14207,14080-14087,14328-14335,14208-14215,14456-14463,14336-14343,14584-14591,14464-14471,14712-14719,14592-14599,14840-14847,14720-14727,14968-14975,14848-14855,15096-15103,14976-14983,15224-15231,15104-15111,15352-15359,15232-15239,15480-15487,15360-15367,15608-15615,15488-15495,15736-15743,15616-15623,15864-15871,15744-15751,15992-15999,15872-15879,16120-16127,16000-16007,16248-16255,16128-16135,16376-16383,16256-16263,16504-16511,16384-16391,16632-16639,16512-16519,16760-16767,16640-16647,16888-16895,16768-16775,17016-17023,16896-16903,17144-17151,17024-17031,17272-17279,17152-17159,17400-17407,17280-17287,17528-17535,17408-17415,17656-17663,17536-17543,17784-17791,17664-17671,17912-17919,17792-17799,18040-18047,17920-17927,18168-18175,18048-18055,18296-18303,18176-18183,18424-18431,18304-18311,18552-18559,18432-18439,18680-18687,18560-18567,18808-18815,18688-18695,18936-18943,18816-18823,19064-19071,18944-18951,19192-19199,19072-19079,19320-19327,19200-19207,19448-19455,19328-19335,19576-19583,19456-19463,19704-19711,19584-19591,19832-19839,19712-19719,19960-19967,19840-19847,20088-20095,19968-19975,20216-20223,20096-20103,20344-20351,20224-20231,20472-20479,20352-20359,20600-20607,20480-20487,20728-20735,20608-20615,20856-20863,20736-20743,20984-20991,20864-20871,21112-21119,20992-20999,21240-21247,21120-21127,21368-21375,21248-21255,21496-21503,21376-21383,21624-21631,21504-21511,21752-21759,21632-21639,21880-21887,21760-21767,22008-22015,21888-21895,22136-22143,22016-22023,22264-22271,22144-22151,22392-22399,22272-22279,22520-22527,22400-22407,22648-22655,22528-22535,22776-22783,22656-22663,22904-22911,22784-22791,23032-23039,22912-22919,23160-23167,23040-23047,23288-23295,23168-23175,23416-23423,23296-23303,23544-23551,23424-23431,23672-23679,23552-23559,23800-23807,23680-23687,23928-23935,23808-23815,24056-24063,23936-23943,24184-24191,24064-24071,24312-24319,24192-24199,24440-24447,24320-24327,24568-24575,24448-24455,24696-24703,24576-24583,24824-24831,24704-24711,24952-24959,24832-24839,25080-25087,24960-24967,25208-25215,25088-25095,25336-25343,25216-25223,25464-25471,25344-25351,25592-25599,25472-25479,25720-25727,25600-25607,25848-25855,25728-25735,25976-25983,25856-25863,26104-26111,25984-25991,26232-26239,26112-26119,26360-26367,26240-26247,26488-26495,26368-26375,26616-26623,26496-26503,26744-26751,26624-26631,26872-26879,26752-26759,27000-27007,26880-26887,27128-27135,27008-27015,27256-27263,27136-27143,27384-27391,27264-27271,27512-27519,27392-27399,27640-27647,27520-27527,27768-27775,27648-27655,27896-27903,27776-27783,28024-28031,27904-27911,28152-28159,28032-28039,28280-28287,28160-28167,28408-28415,28288-28295,28536-28543,28416-28423,28664-28671,28544-28551,28792-28799,28672-28679,28920-28927,28800-28807,29048-29055,28928-28935,29176-29183,29056-29063,29304-29311,29184-29191,29432-29439,29312-29319,29560-29567,29440-29447,29688-29695,29568-29575,29816-29823,29696-29703,29944-29951,29824-29831,30072-30079,29952-29959,30200-30207,30080-30087,30328-30335,30208-30215,30456-30463,30336-30343,30584-30591,30464-30471,30712-30719,30592-30599,30840-30847,30720-30727,30968-30975,30848-30855,31096-31103,30976-30983,31224-31231,31104-31111,31352-31359,31232-31239,31480-31487,31360-31367,31608-31615,31488-31495,31736-31743,31616-31623,31864-31871,31744-31751,31992-31999,31872-31879,32120-32127,32000-32007,32248-32255,32128-32135,32376-32383,32256-32263,32504-32511,32384-32391,32632-32639,32512-32519,32760-32767,32640-32647,32888-32895,32768-32775,33016-33023,32896-32903,33144-33151,33024-33031,33272-33279,33152-33159,33400-33407,33280-33287,33528-33535,33408-33415,33656-33663,33536-33543,33784-33791,33664-33671,33912-33919,33792-33799,34040-34047,33920-33927,34168-34175,34048-34055,34296-34303,34176-34183,34424-34431,34304-34311,34552-34559,34432-34439,34680-34687,34560-34567,34808-34815,34688-34695,34936-34943,34816-34823,35064-35071,34944-34951,35192-35199,35072-35079,35320-35327,35200-35207,35448-35455,35328-35335,35576-35583,35456-35463,35704-35711,35584-35591,35832-35839,35712-35719,35960-35967,35840-35847,36088-36095,35968-35975,36216-36223,36096-36103,36344-36351,36224-36231,36472-36479,36352-36359,36600-36607,36480-36487,36728-36735,36608-36615,36856-36863,36736-36743,36984-36991,36864-36871,37112-37119,36992-36999,37240-37247,37120-37127,37368-37375,37248-37255,37496-37503,37376-37383,37624-37631,37504-37511,37752-37759,37632-37639,37880-37887,37760-37767,38008-38015,37888-37895,38136-38143,38016-38023,38264-38271,38144-38151,38392-38399,38272-38279,38520-38527,38400-38407,38648-38655,38528-38535,38776-38783,38656-38663,38904-38911,38784-38791,39032-39039,38912-38919,39160-39167,39040-39047,39288-39295,39168-39175,39416-39423,39296-39303,39544-39551,39424-39431,39672-39679,39552-39559,39800-39807,39680-39687,39928-39935,39808-39815,40056-40063,39936-39943,40184-40191,40064-40071,40312-40319,40192-40199,40440-40447,40320-40327,40568-40575,40448-40455,40696-40703,40576-40583,40824-40831,40704-40711,40952-40959,40832-40839,41080-41087,40960-40967,41208-41215,41088-41095,41336-41343,41216-41223,41464-41471,41344-41351,41592-41599,41472-41479,41720-41727,41600-41607,41848-41855,41728-41735,41976-41983,41856-41863,42104-42111,41984-41991,42232-42239,42112-42119,42360-42367,42240-42247,42488-42495,42368-42375,42616-42623,42496-42503,42744-42751,42624-42631,42872-42879,42752-42759,43000-43007,42880-42887,43128-43135,43008-43015,43256-43263,43136-43143,43384-43391,43264-43271,43512-43519,43392-43399,43640-43647,43520-43527,43768-43775,43648-43655,43896-43903,43776-43783,44024-44031,43904-43911,44152-44159,44032-44039,44280-44287,44160-44167,44408-44415,44288-44295,44536-44543,44416-44423,44664-44671,44544-44551,44792-44799,44672-44679,44920-44927,44800-44807,45048-45055,44928-44935,45176-45183,45056-45063,45304-45311,45184-45191,45432-45439,45312-45319,45560-45567,45440-45447,45688-45695,45568-45575,45816-45823,45696-45703,45944-45951,45824-45831,46072-46079,45952-45959,46200-46207,46080-46087,46328-46335,46208-46215,46456-46463,46336-46343,46584-46591,46464-46471,46712-46719,46592-46599,46840-46847,46720-46727,46968-46975,46848-46855,47096-47103,46976-46983,47224-47231,47104-47111,47352-47359,47232-47239,47480-47487,47360-47367,47608-47615,47488-47495,47736-47743,47616-47623,47864-47871,47744-47751,47992-47999,47872-47879,48120-48127,48000-48007,48248-48255,48128-48135,48376-48383,48256-48263,48504-48511,48384-48391,48632-48639,48512-48519,48760-48767,48640-48647,48888-48895,48768-48775,49016-49023,48896-48903,49144-49151,49024-49031,49272-49279,49152-49159,49400-49407,49280-49287,49528-49535,49408-49415,49656-49663,49536-49543,49784-49791,49664-49671,49912-49919,49792-49799,50040-50047,49920-49927,50168-50175,50048-50055,50296-50303,50176-50183,50424-50431,50304-50311,50552-50559,50432-50439,50680-50687,50560-50567,50808-50815,50688-50695,50936-50943,50816-50823,51064-51071,50944-50951,51192-51199,51072-51079')
    MaskBTP(Workspace='data', Instrument='CNCS', Bank='35-38', MaskedDetectors='34816-38911')

    Ei, _FMP, _FMI, T0 = GetEi(data)

    tibmin,tibmax=SuggestTibCNCS(Ei)

    data_DGS,_ = DgsReduction(
            SampleInputWorkspace = data,
            SampleInputMonitorWorkspace = data,
            EnergyTransferRange = [-0.07*Ei, 100., 0.07*Ei],
            SofPhiEIsDistribution = True, #this will keep the output data as a histogram
            TimeIndepBackgroundSub = True,
            TibTofRangeStart = tibmin,
            TibTofRangeEnd = tibmax,
            CorrectKiKf = True,
            IncidentBeamNormalisation='ByCurrent',
            )

    my_wavelength = 9.044/np.sqrt(Ei)
    my_max_Q = 4.*np.pi*np.sin(135.*np.pi/180./2.)/my_wavelength
    


fig.show()

fig, ax = plt.subplots()

fig.show()

#plt.close('all')

"""
LoadNexus(Filename='/SNS/CNCS/IPTS-20360/shared/autoreduce/van_273266.nxs', OutputWorkspace='__VAN')
CreateSingleValuedWorkspace(OutputWorkspace='__meanval', DataValue='12.795814283715835')
Divide(LHSWorkspace='__VAN', RHSWorkspace='__meanval', OutputWorkspace='__VAN')
SaveNexus(InputWorkspace='__VAN', Filename='/SNS/CNCS/IPTS-20360/shared/autoreduce/van_273266.nxs')
Load(Filename='/SNS/CNCS/IPTS-20360/shared/autoreduce/van_273266.nxs', OutputWorkspace='van_273266')


"""
